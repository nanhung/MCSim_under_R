---
title: "Tutorial 0: MCSim Introductory"
subtitle: "<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>"
author: ""
date: "April 18, 2019"
output:
  xaringan::moon_reader:
    css: ["default", metropolis, metropolis-fonts]
    nature:
          highlightLines: true
---

background-image: url(https://upload.wikimedia.org/wikipedia/commons/5/5a/Mcsimlogo.png)
background-size: 200px
background-position: 90% 10% 

```{r setup, include=FALSE}
htmltools::tagList(rmarkdown::html_dependency_font_awesome())
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_knit$set(root.dir = "C:/MinGW/msys/1.0/home/nhsieh/MCSim_under_R")
#knitr::opts_knit$set(root.dir = "C:/Users/lenovo/MCSim_under_R")
knitr::opts_knit$set(root.dir =  "/Users/nanhung/Rproj/MCSim_under_R")
```

# Talk overview

## 1. GNU MCSim

## 2. MCSim-related publication

## 3. MCSim under R

## 4. MCSim-related R package

## 5. Workflow 

## 6. Example 

---

class: inverse, middle

# What GNU MCSim is?

---

background-image: url(https://i.ibb.co/nPHgMrN/MCSim-JSS.png)
background-size: 800px
background-position: 50% 90% 

# GNU MCSim Project

- The project started by Don Maszle and [Frederic Y. Bois](https://en.wikipedia.org/wiki/Frédéric_Y._Bois) in UC Berkeley, 1991. 

- Discussions with Stuart Beal at UCSF School of Pharmacy, led the team to investigate the use of **Markov chain Monte Carlo** techniques for PBPK models' calibration. 

- The corresponding code was developed by Maszle, during a project in collaboration with [Andrew Gelman](https://en.wikipedia.org/wiki/Andrew_Gelman), then professor at UC Berkeley Statistics Department. 

- Additional code written by Ken Revzan allowed the definition and Bayesian calibration of hierarchical statistical models.

- At the time of these developments (around 1996) those capabilities were unique for a freely distributed, easily accessible, efficient and quite versatile software.

- Published to *Journal of Statistical Software* in 1997 (version 4.2.0) . 

</br>

</br>

.right[
[(source)](https://en.wikipedia.org/wiki/MCSim)]

---

background-image: url(https://upload.wikimedia.org/wikipedia/commons/5/5a/Mcsimlogo.png)
background-size: 100px
background-position: 90% 90% 

# Version history

<span style="color: red"> 
February 19th, 2019 - Release of GNU MCSim version 6.1.0.
</span>

>Version 6.1.0 offers an automatic setting of the inverse-temperature scale
in simulated tempering MCMC. This greatly facilitates the uses of this
powerful algorithm (convergence is reached faster, **only one chain needs** to be
run if inverse-temperature zero is in the scale, **Bayes factors** can be
calculated for model choice).

.pull-right[

]
.font50[
- 6.0.1 (05 May 2018)
- 6.0.0 (24 February 2018)
- 5.6.6 (21 January 2017)
- 5.6.5 (27 February 2016)
- 5.6.4 (30 January 2016)
- 5.6.3 (1 January 2016)
- 5.6.2 (24 December 2015)
- 5.6.1 (21 December 2015)
- 5.6.0 (16 December 2015)
- 5.5.0 (17 March 2013)
- 5.4.0 (18 January 2011)
- 5.3.1 (3 March 2009)
- 5.3.0 (12 January 2009)
- 5.2 beta (29 January 2008)
- 5.1 beta (18 September 2006)
- 5.0.0 (4 January 2005)
- 4.2.0 (15 October 2001)
- 4.1.0 (1 August 1997)
- 4.0.0 (24 March 1997)
]

---

# Types of Simulation

.font90[
**Simple simulation**  
- Straigth simulations (set parameter values and initial conditions).

**Used to:** Model testing when building the model 

<hr>

**Monte Carlo simulations**  
- Perform repeated (stochastic) simulations across a randomly sampled region of the model parameter space.

**Used to:** Check possible simulation (under given parameter distributions) results before model calibration

<hr>

**SetPoints simulation**   
- Solves the model for a series of specified parameter sets. You can create these parameter sets yourself or use the output of a previous Monte Carlo or MCMC simulation.

**Used to:** Local/global sensitivity analysis
]

---

# Types of Simulation

**Markov-chain Monte Carlo (MCMC) simulation**  
- Performs a series of simulations along a Markov chain in the model parameter space. They can be used to obtain the Bayesian posterior distribution of the model parameters, given a statistical model, prior parameter distributions and data for which a likelihood function can be computed. The program handles hierarchical statistical models.

---

background-image: url(https://raw.githubusercontent.com/nanhung/MCSim_under_R/master/doc/fig/mcmc_diagram.png)
background-size: contain

# Bayesian multilevel modeling

[Sourcing from sbml.org](http://sbml.org/images/1/17/StatMeeting_F_Bois.pdf)

---

# Types of Simulation

**"Optimal Design" procedure**

Optimizes the number and location of observation times for experimental conditions, in order to minimize the variance of a parameter or an output you specify, given a structural model, a statistical model, and prior distributions for their parameters

<hr>

**Systems Biology Markup Language (SBML)**

GNU MCSim can read SBML models, which provides a standard for representing biochemical pathway models. It can code for models of metabolism, cell-signaling, transcription, etc. SBML is maintained since the mid-2000 by an international community of software developers and users. [[source]](https://academic.oup.com/bioinformatics/article/25/11/1453/330661)

---

class: inverse, middle

# What GNU MCSim can do in toxicology?

---

background-image: url(https://ars.els-cdn.com/content/image/1-s2.0-S027323000600095X-gr3.jpg)
background-size: 280px
background-position: 60% 80% 

# Related publication 

Chiu and Bois (2006) - [Revisiting the population toxicokinetics of tetrachloroethylene](https://link.springer.com/article/10.1007/s00204-006-0061-9)

Hack et al. (2006) - [Bayesian population analysis of a harmonized physiologically based pharmacokinetic model of trichloroethylene and its metabolites](https://www.sciencedirect.com/science/article/pii/S027323000600095X)

<hr>

<img src="https://ars.els-cdn.com/content/image/1-s2.0-S027323000600095X-gr1.jpg" height="400px" />

---

# Related publication

Chiu and Bois (2007) - [An approximate method for population toxicokinetic analysis with aggregated data](https://link.springer.com/article/10.1198/108571107X229340) 

- Applied Hierarchical Bayesian approach to estimate inter-individual variability

<img src="https://i.ibb.co/23QQ5Nz/Chiu-2017.png" height="260px" />

---

background-image: url(https://ars.els-cdn.com/content/image/1-s2.0-S0041008X09003238-gr3_lrg.jpg)
background-size: 600px
background-position: 50% 90% 

# Related publication

Chiu et al. (2009) - [Characterizing uncertainty and population variability in the toxicokinetics of trichloroethylene and metabolites in mice, rats, and humans using an updated database, physiologically based pharmacokinetic (PBPK) model, and Bayesian approach](https://www.sciencedirect.com/science/article/pii/S0041008X09003238)

Chiu and Ginsberg (2011) - [Development and evaluation of a harmonized physiologically based pharmacokinetic (PBPK) model for perchloroethylene toxicokinetics in mice, rats, and humans](https://www.sciencedirect.com/science/article/pii/S0041008X11001141)

---

background-image: url(https://i.ibb.co/VHT9qZ3/chiu2019.jpg)
background-size: 500px
background-position: 50% 80% 

# Related publication 

- Characterizing PBPK parameters from individuals to population

- Evaluating population **variability** and parameter **uncertainty**

- Cross-species comparisons of metabolism in **risk assessment**

.footnote[
.font50[
Chiu et al. 2009.  
https://doi.org/10.1016/j.taap.2009.07.032  
]]

---

background-image: url(https://i.ibb.co/tYDnPDb/chiu2014-2.png)
background-size: 500px
background-position: 80% 65% 

# Related publication from our group 

### Inter-strain & inter-individual variability

Chiu et al. (2014) - [Physiologically-Based Pharmacokinetic (PBPK) Modeling of Inter-strain Variability in Trichloroethylene Metabolism in the Mouse](https://ehp.niehs.nih.gov/doi/full/10.1289/ehp.1307623?url_ver=Z39.88-2003&rfr_id=ori:rid:crossref.org&rfr_dat=cr_pub%3dpubmed)

<hr>

<img src="https://i.ibb.co/DVWYytX/chiu2014.png" height="340px" />

[(source)](https://www.toxicology.org/groups/ss/ophss/docs/OPHSS_Webinar_ZeiseChiu_30Oct2014.pdf)

---

background-image: url(https://ars.els-cdn.com/content/image/1-s2.0-S0300483X18301781-gr5_lrg.jpg)
background-size: 400px
background-position: 70% 80% 

# Related publication

Dalaijamts et al. (2018) - [Incorporation of the glutathione conjugation pathway in an updated physiologically-based pharmacokinetic model for perchloroethylene in mice](https://www.sciencedirect.com/science/article/pii/S0041008X18302436)

Luo et al. (2018) - [Comparative analysis of metabolism of trichloroethylene and tetrachloroethylene among mouse tissues and strains](https://www.sciencedirect.com/science/article/pii/S0300483X18301781)

Luo et al. (Accepted) - Using Collaborative Cross Mouse Population to Fill Data Gaps in Risk Assessment A Case Study of Population-based Analysis of Toxicokinetics and Kidney Toxicodynamics of Tetrachloroethylene

<img src= "https://ars.els-cdn.com/content/image/1-s2.0-S0300483X18301781-gr2_lrg.jpg" height="300px" />

---

# Related publication

*U.S. Food and Drug Administration. Enhancing the reliability, efficiency, and usability of Bayesian population PBPK modeling - Create, implement, and evaluate a robust Global Sensitivity Analysis algorithm to reduce PBPK model parameter dimensionality.*

<hr>

Hsieh et al. (2018) - [Applying a Global Sensitivity Analysis Workflow to Improve the Computational Efficiencies in Physiologically-Based Pharmacokinetic Modeling](https://www.frontiersin.org/articles/10.3389/fphar.2018.00588/full)

Bois et al. (Submitted) - Well tempered MCMC simulations for population pharmacokinetic models

- Based on the latest version 6.1.0

---

class: inverse, middle

# Why we use GNU MCSim with R(Studio)?

---

background-image: url(https://upload.wikimedia.org/wikipedia/commons/9/93/GPLv3_Logo.svg)
background-size: 200px
background-position: 50% 80% 

# Advantages in MCSim and R

.center[.font120[*"Free and Open Source Software"* under GNU General Public License]]

> - The freedom to run the program as you wish, for any purpose (freedom 0).
> - The freedom to study how the program works, and change it so it does your computing as you wish (freedom 1). Access to the source code is a precondition for this.
> - The freedom to redistribute copies so you can help others (freedom 2).
> - The freedom to distribute copies of your modified versions to others (freedom 3). By doing this you can give the whole community a chance to benefit from your changes. Access to the source code is a precondition for this.


---

# Advantages in MCSim and R

.pull-left[
### GNU MCSim

**Simulation package, which allows you to:**

- design and run simulation models (using algebraic or differential equations)

- perform Monte Carlo stochastic simulations

- do bayesian inference through Markov Chain Monte Carlo simulations

- have faster computing speed than other simulation software/packages (e.g., Asclx, Berkeley Madonna, RStan)

]

.pull-right[
### R

**Programming language that allows you to:**

- conduct statistic analysis (summarization, estimation)

- visualize simulation result 

- have various community supports (e.g., Stack Overflow, R User groups)

- use various packages to analyze result (e.g., `CODA`, `BOA`, `rstan`)

- do sensitivity analysis (e.g., `sensitivity`, `pksensi`)

] 

---

background-image: url(http://lcolladotor.github.io/figs/2016-03-07-BiocParallel/parallel.gif)
background-size: 550px
background-position: 90% 1% 

# Advantages in MCSim and R

.font120[*"Parallel computing"*]  
<img src="http://lcolladotor.github.io/figs/2016-03-07-BiocParallel/cloud.jpg" height="220px" />

- Run multiple MCMC chains with multiple CPUs  

- High performance computing (cloud) computing

.footnote[[*source*](http://lcolladotor.github.io/2016/03/07/BiocParallel/#)] 

???

http://lcolladotor.github.io/2016/03/07/BiocParallel/#.XLHOOy2ZOnc

---

background-image: url(https://i.ibb.co/VvsMMhD/Screen-Shot-2019-04-12-at-12-33-42-PM.png)
background-size: 440px
background-position: 80% 95% 

class:clear

.font120[
<strong>Population pharmacokinetic reanalysis of a Diazepam PBPK model: a comparison of *Stan* and *GNU MCSim*</strong>
]

.font80[
Periklis Tsiros, Frederic Y. Bois, Aristides Dokoumetzidis, Georgia Tsiliki, Haralambos Sarimveis 

- The aim of this study is to benchmark two Bayesian software tools, namely *Stan* and *GNU MCSim*, that use different Markov chain Monte Carlo (MCMC) methods for the estimation of physiologically based pharmacokinetic (PBPK) model parameters. 

- The software tools were applied and compared on the problem of updating the parameters of a Diazepam PBPK model, using time-concentration human data. Both tools produced very good fits at the individual and population levels, despite the fact that *GNU MCSim* is not able to consider multivariate distributions. 

- *Stan* outperformed GNU MCSim in sampling efficiency, due to its almost uncorrelated sampling. 

- However, *GNU MCSim* exhibited much **faster convergence** and performed better in terms of effective samples produced per unit of time.
]


.font60[
Journal of Pharmacokinetics and Pharmacodynamics; https://doi.org/10.1007/s10928-019-09630-x

Original Paper; First Online: 04 April 2019
]

---

# MCSim related R package 

**httk: R Package for High-Throughput Toxicokinetics**

.font80[
Robert G. Pearce, R. Woodrow Setzer, Cory L. Strope, Nisha S. Sipes, John F. Wambaugh
]

> MCSim (Bois and Maszle 1997) was used for converting the model equations into C code, which is used with deSolve (Soetaert et al. 2016) in solving each system of equations.

.right[
.font60[
journal of statistical software; http://dx.doi.org/10.18637/jss.v079.i04
]
]

<hr>

**pksensi:  R Package for Global Sensitivity Analysis in Pharmacokinetic Modeling**

.font80[ Nan-Hung Hsieh, Brad Reisfeld, Weihsueh A. Chiu]

>pksensi implements the global sensitivity analysis workflow to investigate the parameter uncertainty and sensitivity in pharmacokinetic (PK) models, especially the physiologically based pharmacokinetic (PBPK) model with multivariate outputs. The package also provides some functions to check the convergence and sensitivity of model parameters.

.right[[![CRAN\_Status\_Badge](http://www.r-pkg.org/badges/version-last-release/pksensi)](https://cran.r-project.org/package=pksensi)]

---

background-image: url(http://devhumor.com/content/uploads/images/November2017/step-by-step-debugging.png)
background-size: 450px
background-position: 95% 90% 

# Disadvantages in MCSim and R

### Difficult learning curve (CLI-based, not GUI)

### Requires coding/programming skill

### Requires installation of extra program or package

### Requires additional setting manually

### Requires **"debugging"**

---

# Run GNU MCSim in Windows

.font140[
*GNU MCSim* is a simulation package, written in C, which can run under different platforms (GNU/Linux, MacOS, and Windows). 

However, the basic tools in the Windows system are not available to build and run GNU MCSim. It needs a bit more extra steps to install and execute it. 

Therefore...
]

---

# Run GNU MCSim in Windows

.font120[
- Prof. Weihsueh Chiu proposed a practical method using **minGW** to install it (<https://www.gnu.org/software/mcsim/mcsim_with_minGW.pdf>). 

- Dr. Frederic Bois also provide an alternative method to compile and run GNU MCSim through Rtools. This concept called "MCSim under R". 

- Dr. Nan-Hung Hsieh developed an installation function in R package **pksensi** (<https://cran.r-project.org/web/packages/pksensi/index.html>) to help users easily install GNU MCSim through this function across platforms. 

Here, we proposed an additional idea to run GNU MCSim in **RStudio**, the integrated development environment (IDE) for R user. This project aim to help beginner write and run GNU MCSim's model code in RStudio IDE.
]

---

background-image: url(https://www.rstudio.com/wp-content/uploads/2018/10/RStudio-Logo-Flat.png)
background-size: 300px
background-position: 95% 95% 

# RStudio

### Free and open-source integrated development environment

### Powerful and user friendly programming interface

### R project with version control (e.g., git) 

### Support cloud computing (https://rstudio.cloud/)

---

background-image: url(https://files.explosm.net/comics/comicsavegamenew.png)
background-size: 400px
background-position: 60% 70% 

# Git

### Manage your code (model, input, R script)

### Transfer your file (through GitHub or GitLab)

### Collaboration work

<img src="https://imgs.xkcd.com/comics/git_2x.png" height="300px" />

.font60[.footnote[
https://xkcd.com/1597/
]]


---

background-image: url(https://raw.githubusercontent.com/nanhung/MCSim_under_R/master/doc/fig/download.png)
background-size: 650px
background-position: 50% 70% 

# GNU MCSim under R 

An open R project that aim to help beginner (especially Windows user) run GNU MCSim in **RStudio IDE**. All resources are stored in GitHub repo .font80[(https://github.com/nanhung/MCSim_under_R)]. 
---

class: inverse, middle

# How to use GNU MCSim with R(Studio)?

---

# Workflow (GNU MCSim under R)

The source code of *GNU MCSim* are put into **"mod"** and **"sim"** folders. In addition, we need two types of file called **"model-file"** (include model structure and default parameter values) and **"input-file"** (include given parameter value/distribution and/or observation data)

.font120[The workflow include three steps:]

1. Making GNU MCSim program 

  Use the files in **"mod"** folder to 

  - build MCSim program named `mod.exe`

2. Build model program 
  
  Use the files in **"sim"** folder to 

  - build model program (&ast;.exe) with (1) `mod.exe` and (2) **"model-file"**

2. Run simulation 
  
  - Use model program and **"input-file"** to run simulation and generate result.

---

# Overview

The software consists in two pieces, a **model generator** and a **simulation engine**:

<hr>

The model generator, **"mod"**

- Created to facilitate structural model definition and maintenance, while keeping execution time short. You code your model using a simplified syntax and mod translates it in C.



The simulation engine, **"sim"**

- A set of routines which are linked to your model during compilation to produce executable code. After that you can run simulations of your model under a variety of conditions, specify an associated statistical model, and perform simulations.


---

background-image: url(https://raw.githubusercontent.com/nanhung/MCSim_under_R/master/doc/fig/flowchart.png)
background-size: contain

# Overall Workflow

---


# Syntax of the model description file

.code70[

```r
# Model description file (this is a comment)

<Global variable specifications>

States = { 
  <state variables for the model, such as quantity> 
}
Outputs = { 
  <output variables, such as concentration> 
}
Inputs = { 
  <input variables, such as exposure dose>
}
Initialize {
  <Equations for initializing or scaling model parameters>
}
Dynamics {
  <Equations for computing derivatives of the state variables>
}
Jacobian {
  <Equation for the Jacobian of the state derivatives>
}
CalcOutputs {
  <Equations for computing output variables>
}
End. # mandatory ending keyword
```
]

---

# Example of model description file

.code60[
```r
# File name:  digoxin.model.R

# Variables
States = { A_central, A_periph }
Inputs = { Dose }
Outputs = { C_central }

# Structural model parameters
k_12 = 1.02;
k_21 = 0.15;
k_10 = 0.18;
V_central = 58.2;

# Measurement error 
Ve_C_central = 1;

# Initalization
Initialize { A_central = Dose; }

# Dynamics
Dynamics {
  # Central compartment quantity
  dt(A_central) = k_21 * A_periph - k_12 * A_central - k_10 * A_central;
  # Peripheral compartment quantity 
  dt(A_periph) = k_12 * A_central - k_21 * A_periph;
  # Concentration
  C_central = A_central / V_central;
}
CalcOutputs { 
	C_central = (C_central < 1.0e-15 ? 1.0e-15 : C_central) ; 
}
End.
```
]

---

# General syntax 

Variable assignments 

```r
<variable-name> = <constant-value-or-expression> ;
```

Colon conditional assignments 

```r
<variable-name> = (<test> ? <value-if-true> : <value-if-false>);
```

For example

```r
Adjusted_Param = (Input_Var > 0.0 ? Param * 1.1 : Param);
```

.footnote[
Some other assignments can be found in  [GNU MCSim's user manual 5.3.1](https://www.gnu.org/software/mcsim/mcsim.html#Syntax-of-mod-files)
]

---

# Comments on style

> For your model file to be **readable** and **understandable**.

- All variable names begin with a capital letter followed by meaningful lower case subscripts.
- Where two subscripts are necessary, they can be separated by an underscore, such as in `Qb_fat`.
- Where there is only one subscript an underscore can still be used to increase readability as in `Q_fat`.
- Where two words are used in combination to name one item, they can be separated visually by capitalizing each word, as in `BodyWt`.

.footnote[
Some other contents can be found in  [GNU MCSim's user manual 5.3.11](https://www.gnu.org/software/mcsim/mcsim.html#Syntax-of-mod-files)
]

---

background-image: url(https://irudnyts.github.io/images/posts/2019-01-14-r-coding-style-guide/assignment.jpg)
background-size: 350px
background-position: 95% 20% 

# Comments on style (R)

.font70[
**Using = instead of <- for assignment**

```
# Good
x <- 5
# Bad
x = 5
```

**Without spacing**

```
# Good
average <- mean(feet / 12 + inches, na.rm = TRUE)

# Bad
average<-mean(feet/12+inches,na.rm=TRUE)
```

**Put more than one statement (command) per line**

```
# Good
x <- 1
x <- x + 1
    
# Bad 
x <- 1; x <- x + 1
```
]

</br>

.font80[
> “Good coding style is like using correct punctuation.   
> You can manage without it, but it sure makes things easier to read.”  
> — Hadley Wickham, Chief Scientist @RStudio
]

.right[
.font50[
[[source1](http://adv-r.had.co.nz/Style.html)]
[[source2](https://irudnyts.github.io/r-coding-style-guide/)]
]
]

---

# Syntax of simulation definition file

## For the basic simulation 

```r
# Input-file (text after # are comments)
<Global assignments and specifications>
Simulation {
  <Specifications for first simulation>
}
Simulation {
  <Specifications for second simulation>
}
# Unlimited number of simulation specifications
End. # Mandatory End keyword. Everything after this line is ignored
```

---

# Syntax of simulation definition file

## For MCMC simulation

```r
# Input-file
<Global assignments and specifications>
Level {
  # Up to 10 levels of hierarchy
  Simulation {
    <Specifications and data for first simulation>
  }
  Simulation {
    <Specifications and data for second simulation>
  }
  # Unlimited number of simulation specifications
} # end Level
End. # Mandatory keyword.
```
---

# Example of simulation definition file

.code60[
```r
#File name: dogoxin.in.R

Simulation {
  Dose = 509;
  Print (C_central, 0.5, 1, 2, 3, 4, 5, 6, 7, 8, 23);
}

End. 
```
]

</br>

.font80[
Here is the simulation output:
]
.code60[
```{R eval = T, warning=FALSE}
mcsim(model = "digoxin.model.R", input = "digoxin.in.R")
```
]

---

# Example of simulation definition file

.code60[
```r
#File name: dogoxin.mcmc.in.R

MCMC("sim.out","", # name of output and restart file
     "",           # name of data file
     50000,0,      # iterations, print predictions flag,
     10,50000,     # printing frequency, iters to print
     10101010);    # random seed (default )

Level { # top level
  Distrib(k_12, TruncLogNormal, 0.2, 4, 0.001, 2);
  Distrib(k_21, TruncLogNormal, 0.2, 4, 0.001, 2);
  Distrib(k_10, TruncLogNormal, 0.2, 4, 0.001, 2);
  Distrib(V_central, TruncLogNormal, 40, 4, 40, 60);
  Distrib(Ve_C_central, LogUniform, 0.01, 0.5);
  
  Likelihood(C_central , Normal, Prediction(C_central) , Ve_C_central);
  
  Simulation {
  Dose = 509;
  Print (C_central, 0.5, 1, 2, 3, 4, 5, 6, 7, 8, 23);
  Data (C_central, 4.6244, 2.7654, 1.3224, 0.9563, 0.8843, 0.8648, 0.8363, 0.7478, 0.7232, 0.5655);
  }
} 
End. 
```
]

---

# Distribution functions

.font80[
- **Binomial**, needs two strictly positive numbers: the probability p (a real in the interval [0;1]), and the sample size N, an integer. If N is not given as an integer it will be rounded down during the computations.
- **Cauchy**, takes one strictly positive real number as parameter: its scale s.
- **InvGamma** (inverse gamma distribution), needs two strictly positive real parameters: the shape and the scale.
- **LogNormal**, takes two reals numbers as parameters: the geometric mean (exponential of the mean in log-space) and the geometric standard deviation (exponential, strictly superior to 1, of the standard deviation in log-space).
- **LogUniform** with two shape parameters: the minimum and the maximum of the sampling range (real numbers) in natural space.
- **Normal** takes two reals numbers as parameters: the mean and the standard deviation, the latter being strictly positive.
- **Normal_v** is also the normal distribution with the variance instead of the standard deviation as second parameter. 
- **TruncNormal** (truncated normal distribution), takes four real parameters: the mean, the standard deviation (strictly positive), the minimum and the maximum.
- **StudentT**, requires three parameters: its number of degrees of freedom (an integer), its mean, and its standard deviation.
- **TruncLogNormal** (truncated lognormal distribution), uses four real numbers: the geometric mean and geometric standard deviation (strictly superior to 1)
]

.footnote[
More function in [GNU MCSim User’s Manual](https://www.gnu.org/software/mcsim/mcsim.html#Distrib_0028_0029-specification)
]

---

# Input functions

These functions can use to different exposure types

.code60[
```
- PerDose(): # specifies a periodic input of constant

    PerDose(<magnitude>, <period>, <initial-time>, <exposure-time>);

  
- PerExp(): # specifies a periodic exponential input.

    PerExp(<magnitude>, <period>, <initial-time>, <decay-constant>);  

  
- PerTransit(): models a delayed input mechanism  

    PerTransit(<magnitude>, <period>, <initial-time-in-period>, 
              <decay-constant>, <number-of-input-compartments>);  
    
              
- NDoses(): specifies a number of stepwise inputs of variable magnitude and their starting times
    
    NDoses(<n>, <list-of-magnitudes>, <list-of-initial-times>);


- Spikes(): specifies a number of instantaneous inputs of variable magnitude and their exact times of occurrence.
    
    Spikes(<n>, <list-of-magnitudes>, <list-of-times>);

```
]

---

# Main functions

Here are the R functions that can help you run GNU MCSim more easily. All R functions are put in `function.R` in MCSim folder.

```{r, eval=F}
makemcsim(model)
```

- Preprocessing and compiling the model-file to the executable file as `makemcsim` in GNU MCSim. The `model` assignment is a string giving the name of the model-file (e.g., `"pbpk.model.R"`). 

```{r, eval=F}
mcsim(model, input)
```

- Using the compiled program with the input-file to run the simulation. The `input` assignment is a string giving the name of the input-file (e.g., `"pbpk.in.R"`)

- This function can also automatically compile the model, if you forgot to use `makemcsim()` to create model program.

---

# Other functions

.font90[
These functions are used to perform basic setting.

```{r, eval=F}
set_PATH(PATH)
```

- Detecting, checking, and setting the C compiler in your computer. This process will automatically execute. The default PATH setting is `"c:/Rtools/mingw_64/bin"`. 

```{r, eval=F}
makemod()
```

- Creating MCSim program `mod.exe`. 

```r
clear()
```

- Removing all executable and output files with extension `.exe`, `.out`, and `.perks` in the working directory. This function is used to ensure that all simulation process can be reproduced without misusing the old version of the file with the same file name. This function will not remove `mod.exe`.

```r
report()
```

- Reporting the system setting. 

]

---

# Example: linear modeling

.pull-left[

model-file

.code70[
```r
# File name: linear.model.R

Outputs = {y}

# Model Parameters
A = 0; # Default value of intercept
B = 1; # Default value of slope

# Statistical parameter
SD_true = 0;

CalcOutputs { 
  y = A + B * t + NormalRandom(0,SD_true); 
}

End. 
```
]]

.pull-right[

input-file

.code70[
```r
# File name: linear.in.R
# $ ./mcsim.linear.model.R.exe linear.in.R

Simulation { # 1 simple simulation
  
  A  = 1; # given value of intercept 
  B  = 2; # given value of slope 
  SD_true = 2; # given SD of noise 
  
  PrintStep (y, 0, 10, 1); 
}

END.
```
]]

---

# Example: linear modling

A simple way to check result is stored the output in a variable and print it as, 

```{R eval = T, warning=FALSE}
out <- mcsim(model = "linear.model.R", input = "linear.in.R")
out
```

---

# Example: linear modling

If you forgot to assign a variable to store your output, you can use `read.delim()` to read the output file as,

```{R eval = T, warning=FALSE}
out <- read.delim(file = "sim.out", skip = 1)
out
```

--

**Question: why `skip = 1`?**

---

# Example: linear modling

Visualization the simulation result by R base plot and ggplot

.pull-left[
.code60[
```{R eval=T, fig.height=5, fig.width=5, warning=FALSE}
plot(x=out$Time, y=out$y)
abline(a=1, b=2)
```
]]

.pull-right[
.code60[
```{R eval=T, fig.height=5, fig.width=5, warning=FALSE}
library(ggplot2)
ggplot(out, aes(x=Time, y=y)) + 
  geom_point() +
  geom_abline(intercept = 1, slope = 2)
```
]]


---

# Additional R packages for analysis

[bayesplot](https://cran.r-project.org/web/packages/bayesplot/index.html) - Plotting functions for posterior analysis.

[data.table](https://cran.r-project.org/web/packages/data.table/index.html) - fast reading of large output file, especially from MCMC with long iterations and high dimensional parameter space.

[pksensi](https://cran.r-project.org/web/packages/pksensi/index.html) - Applying the global sensitivity analysis (eFAST) workflow to investigate the parameter uncertainty and sensitivity in pharmacokinetic (PK) models.

[rstan](https://cran.r-project.org/web/packages/rstan/index.html) - Diagnose the simulation result from MCMC.

[sensitivity](https://cran.r-project.org/web/packages/sensitivity/index.html) - A collection of functions for factor screening, global sensitivity analysis and reliability sensitivity analysis.

[tidyverse](https://cran.r-project.org/web/packages/tidyverse/index.html) - Powerful data science toolbox that can use to manipulate (`dplyr`) and plot (`ggplot`) the simulation result.


```r
# Quick installation
pkgs <- c("bayesplot", "data.table", "pksensi", "rstan", "sensitivity", "tidyverse")
install.packages(pkgs)
```

---

background-image: url(https://raw.githubusercontent.com/nanhung/MCSim_under_R/master/doc/fig/syntaxhighlight.png)
background-size: 620px
background-position: 50% 90% 

# Tips of MCSim under R(Studio)

### Code edit
Generally, the GNU MCSim used `.model` and `.in` as the extension to name the model- and input-file. However, RStudio doesn't support the syntax highlight for these extensions. You can add `.R` as the extension for these files to help you edit your model or input in RStudio with syntax highlighting. Also, it can help you format your code in the code bracket.

---

# Tips of MCSim under R(Studio)

### Example & input
Some example R scripts will put into the `example` folder. To run *GNU MCSim* in model simulation, we need to have two types of file (1) **model** and (2) **input** files. The syntax of the model description file can find in [*GNU MCSim* User's Manual](https://www.gnu.org/software/mcsim/mcsim.html). All example `model` and `input` files are located in the `modeling` folder.

.font80[
[&ast;] You don't need to move your model- or input-file to *input* folder, manually.   
Just run `mcsim(model-file, input-file)` after you finish your code, then they will be moved to **input** folder.
]


```
├── mcsim
├── doc
├── examples
│   ├── linear.R
│   └── test_script.R
├── input
│   ├── digoxin.mcmc.in.R
│   ├── digoxin.model.R
│   ├── linear.in.R
│   ├── linear.mcmc.in.R
│   ├── linear.model.R
│   ├── simple.in.R
│   └── simple.model.R
```

---

class:inverse, middle, center

# Toxicokinetic Modeling Tetrachloroethylene

.footnote[
.left[
Bois et al. (1996) - [Population toxicokinetics of tetrachloroethylene](https://link.springer.com/article/10.1007/s002040050284)  
Chiu and Bois (2006) - [Revisiting the population toxicokinetics of tetrachloroethylene](https://link.springer.com/article/10.1007/s00204-006-0061-9)
]]

---

class:clear

background-image: url(https://i.ibb.co/xHYnFfh/PERC.png)
background-size: 620px
background-position: 50% 50% 

---

# Model composition (1)

.code70[

```r
#----------------------------------------------------------------------
# perc.model
# A four compartment model of Tetrachloroethylene (PERC) toxicokinetics
#----------------------------------------------------------------------
# States are quantities of PERC and metabolite formed, they can be
# output

States = {Q_fat,        # Quantity of PERC in the fat (mg)
          Q_wp,         #   ...   in the well-perfused compartment (mg)
          Q_pp,         #   ...   in the poorly-perfused compartment (mg)
          Q_liv,        #   ...   in the liver (mg)
          Q_exh,        #   ...   exhaled (mg)
          Q_met};       # Quantity of metabolite formed (mg)


Outputs = {C_liv,               # mg/l in the liver
           C_alv,               # ... in the alveolar air
           C_exh,               # ... in the exhaled air
           C_ven,               # ... in the venous blood
           Pct_metabolized,     # % of the dose metabolized
           C_exh_ug};           # ug/l in the exhaled air


Inputs = {C_inh,                # Concentration inhaled (ppm)
          R_ing};               # Ingestion rate (mg/min)
```

]

---

# Model composition (2)

```r
# Constants
# =========
# Conversions from/to ppm: 72 ppm = .488 mg/l
PPM_per_mg_per_l = 72.0 / 0.488;
mg_per_l_per_PPM = 1/PPM_per_mg_per_l;


# Nominal parameter values
# ========================
# Units:
# Volumes: liter
# Time:    minute
# Vmax:    mg / minute
# Km:      mg
# Flows:   liter / minute

```

---

# Model composition (3-1)

```r
# Exposure modeling
# -----------------
InhMag   = 0.0; # inhaled concentration
Period   = 0.0; # period of the exposure/no exposure cycle
Exposure = 0.0; # exposure dutation within a period
C_inh    = PerDose (InhMag, Period, 0.0, Exposure);
IngDose  = 0.0; # ingested dose
```

---

# Model composition (3-2)

```r
# Physiological and pharmacokinetic parameters
# --------------------------------------------

LeanBodyWt = 55;    # lean body weight

# Percent mass of tissues with ranges shown

Pct_M_fat  = .16;   # % total body mass
Pct_LM_liv = .03;   # liver, % of lean mass
Pct_LM_wp  = .17;   # well perfused tissue, % of lean mass
Pct_LM_pp  = .70;   # poorly perfused tissue, recomputed in scale

# Percent blood flows to tissues

Pct_Flow_fat = .09;
Pct_Flow_liv = .34;
Pct_Flow_wp  = .50; # will be recomputed in scale
Pct_Flow_pp  = .07;
```
---

# Model composition (3-3)

```r
# Tissue/blood partition coeficients

PC_fat = 144;
PC_liv = 4.6;
PC_wp  = 8.7;
PC_pp  = 1.4;
PC_art = 12.0;

Flow_pul   = 8.0;    # Pulmonary ventilation rate (minute volume)
Vent_Perf = 1.14;    # ventilation over perfusion ratio

sc_Vmax = .0026;     # scaling coeficient of body weight for Vmax

Km = 1.0;
```

---

# Model composition (4)

```r
# The following parameters are calculated from the above values in
# the Scale section before the start of each simulation.
# They are left uninitialized here.

BodyWt = 0;

V_fat = 0;           # Actual volume of tissues
V_liv = 0;
V_wp  = 0;
V_pp  = 0;

Flow_fat = 0;        # Actual blood flows through tissues
Flow_liv = 0;
Flow_wp  = 0;
Flow_pp  = 0;

Flow_tot = 0;        # Total blood flow
Flow_alv = 0;        # Alveolar ventilation rate

Vmax = 0;            # kg/minute
```

---

# Model composition (5)

.code60[
```r

#---------------------------------------------------------
# Scale
# Scale certain model parameters and resolve dependencies between parameters. Generally the scaling involves a
# change of units, or conversion from percentage to actual units.
#---------------------------------------------------------

Initialize {

  # Volumes scaled to actual volumes
  BodyWt = LeanBodyWt / (1 - Pct_M_fat);
  V_fat  = Pct_M_fat  * BodyWt/0.92;        # density of fat = 0.92 g/ml
  V_liv  = Pct_LM_liv * LeanBodyWt;
  V_wp   = Pct_LM_wp  * LeanBodyWt;
  V_pp   = 0.9 * LeanBodyWt - V_liv - V_wp; # 10% bones

  # Calculate Flow_alv from total pulmonary flow
  Flow_alv = Flow_pul * 0.7;

  # Calculate total blood flow from the alveolar ventilation rate and 
  # the V/P ratio.
  Flow_tot = Flow_alv / Vent_Perf;

  # Calculate actual blood flows from total flow and percent flows 
  Flow_fat = Pct_Flow_fat * Flow_tot;
  Flow_liv = Pct_Flow_liv * Flow_tot;
  Flow_pp  = Pct_Flow_pp  * Flow_tot;
  Flow_wp  = Flow_tot - Flow_fat - Flow_liv - Flow_pp;

  # Vmax (mass/time) for Michaelis-Menten metabolism is scaled
  # by multiplication of bdw^0.7 
  Vmax = sc_Vmax * exp (0.7 * log (LeanBodyWt));

} # End of model initialization

```
]

---

# Model composition (6-1)

.font80[
```r
#---------------------------------------------------------
# Dynamics
# Define the dynamics of the simulation. This section is
# calculated with each integration step. It includes
# specification of differential equations.
#---------------------------------------------------------

Dynamics {

# Venous blood concentrations at the organ exit

Cout_fat = Q_fat / (V_fat * PC_fat);
Cout_wp  = Q_wp  / (V_wp  * PC_wp);
Cout_pp  = Q_pp  / (V_pp  * PC_pp);
Cout_liv = Q_liv / (V_liv * PC_liv);

# Sum of Flow * Concentration for all compartments

dQ_ven = Flow_fat * Cout_fat + Flow_wp * Cout_wp
         + Flow_pp * Cout_pp + Flow_liv * Cout_liv;

# Venous blood concentration

C_ven =  dQ_ven / Flow_tot;

# Arterial blood concentration
# Convert input given in ppm to mg/l to match other units

C_art = (Flow_alv * C_inh / PPM_per_mg_per_l +  dQ_ven) /
        (Flow_tot + Flow_alv / PC_art);
```
]

---

# Model composition (6-2)

.font80[

```r
# Alveolar air concentration

C_alv = C_art / PC_art;

# Exhaled air concentration

C_exh = 0.7 * C_alv + 0.3 * C_inh / PPM_per_mg_per_l;

# Differentials

dt (Q_exh) = Flow_alv * C_alv;
dt (Q_fat) = Flow_fat * (C_art - Cout_fat);
dt (Q_wp)  = Flow_wp  * (C_art - Cout_wp);
dt (Q_pp)  = Flow_pp  * (C_art - Cout_pp);

# Quantity metabolized in liver

dQmet_liv = Vmax * Q_liv / (Km + Q_liv);
dt (Q_liv) = Flow_liv * (C_art - Cout_liv) - dQmet_liv;

# Metabolite formation

dt (Qmet)  = dQmet_liv;

} # End of Dynamics
```
]

---

# Model composition (7)

```r

#---------------------------------------------------------
# CalcOutputs
# The following outputs are only calculated just before values
# are saved.  They are not calculated with each integration step.
#---------------------------------------------------------

CalcOutputs {

# Fraction of TCE metabolized per day

Pct_metabolized = (InhMag ?
                   Qmet / (1440 * Flow_alv * InhMag * mg_per_l_per_PPM):
                   0);

C_exh_ug  = C_exh * 1000; # milli to micrograms

} # End of output calculation

End.
```

---

# Following courses

</br>

.font150[

- Tutorial 1: **Walk-through of working models** (4/25)

- Tutorial 2: **MC simulation and sensitivity analysis** (5/16)

- Tutorial 3: **Bayesian MCMC calibration** (5/23)
]

---

# Take away

.font150[
- *GNU MCSim* & *R* are powerful tool in statistical computing and modeling

- We provide an alternative way to run *GNU MCSim* in **RStudio** that aim to help user learn and familiar with GNU MCSim workflow in R

] 

</br>

Meet problem? Please submit it to  

- MCSim under R GitHub issues [[link](https://github.com/nanhung/MCSim_under_R/issues)]
- Help-mcsim [[link](https://lists.gnu.org/mailman/listinfo/help-mcsim)][[archive](https://lists.gnu.org/archive/html/help-mcsim/)]
- Bug-mcsim [[link](https://lists.gnu.org/mailman/listinfo/bug-mcsim)][[archive](https://lists.gnu.org/archive/html/bug-mcsim/)]


